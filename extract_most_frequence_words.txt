//创建site-segment表
create table site_segment(site string,segment string) partitioned by (part string) row format delimited fields terminated by '\t' stored as textfile;
//向site_segment表添加数据,500G左右
load data local inpath '/home/bd/gogo/site_query_segment/site_query_segment_0000_utf8' into table site_segment partition (part='0000');
load data local inpath '/home/bd/gogo/site_query_segment/site_query_segment_0001_utf8' into table site_segment partition (part='0001');
load data local inpath '/home/bd/gogo/site_query_segment/site_query_segment_0002_utf8' into table site_segment partition (part='0002');
load data local inpath '/home/bd/gogo/site_query_segment/site_query_segment_0003_utf8' into table site_segment partition (part='0003');
load data local inpath '/home/bd/gogo/site_query_segment/site_query_segment_0004_utf8' into table site_segment partition (part='0004');
//向segment进行行转列
create table site_word_1 as select site,word from site_segment lateral view explode(split(trim(segment),' ')) segment as word;
//保留site_word_1词长大于1的
create table site_word_2 as select site,word from site_word_1 where length(word)>1;
//将site为空、edu.cn、com.cn的过滤掉
create table site_word_3 as select site,word from site_word_2 where site !='' and site != 'com.cn' and site != 'edu.cn';
//将site_word按照site、word分组,并统计word的个数再降序排列
create table site_word_count as select site,word,count(word) as count from site_word_3 group by site,word order by count desc;
//创建stopwords表,去除停用词
create table stopwords(stopword string) row format delimited fields terminated by '\t' stored as textfile;
load data local inpath '/home/bd/gogo/site_query_segment/astopwords.txt' into table stopwords;
//去除停用词
create table site_word_count_2 as select a.site,a.word,a.count from site_word_count a where a.word not in (select b.stopword from stopwords b )
//创建色情词包,去除包含色情的site
create table yellowwords(yellowword string) row format delimited fields terminated by '\t' stored as textfile;
load data local inpath '/home/bd/gogo/site_query_segment/yellow.txt' into table yellowwords;
//找到包含色情词的site
create table yellowSite as select a.site,a.word from site_word_3 a where a.word in (select b.yellowword from yellowwords b);
//按照site进行聚合
create table site_yellowwordSet as select site,collect_set(word) yellowwordSet from yellowSite group by site;
//查找site对应的word中最高查找的前5个词
create table site_word_count_top5 as select site,word,count from (select site,word,count,row_number() over (distribute by site sort by count desc ) row_num from site_word_count_2) aa where aa.row_num <=5;
//过滤掉查询词小于5的site
create table site_wordSet_more_then_5 as select site,collect_set(word) as wordSet from site_word_count_top5 group by site having size(wordSet) = 5;
//将集合转换成字符串生成结果集
create table site_wordList_equals_5 as select site,concat_ws(',',wordSet) as wordList from site_wordSet_more_then_5;
//生成最终结果集
create table site_wordList_sample_ver3 as select site,wordList from ( select site, wordList,cast(rand() * 3000000 as int) as idx from site_wordList_equals_5 order by idx) vt limit 200;
INSERT OVERWRITE LOCAL DIRECTORY '/home/bd/gogo/site_query_segment/site_wordList_sample_ver3' row format delimited fields terminated by '\t' select site,wordList from site_wordList_sample_ver3;
//将列转行,生成最终结果集
create table site_wordList as select site,concat_ws(',',collect_set(word)) as wordList from site_word_count_top5 group by site;
//将非法site过滤
create table site_wordList_2 as select site,wordList from site_wordList where site rlike '^[0-9a-z]+.[a-z]+$';
//过滤掉色情site
create table site_wordList_3 as select a.site,a.wordList from site_wordList_2 a where a.site not in (select b.site from site_yellowwordSet b);
//将site_wordList随机采样100行(每个Map采样100)左右,效果不太好
//create table site_wordList_sample as select site,wordList from site_wordList_2 tablesample(50 rows);
//使用rand()来进行随机抽样
create table site_wordList_sample as select site,wordList from ( select site, wordList,cast(rand() * 3000000 as int) as idx from site_wordList_3 order by idx) vt limit 200;
//将样本文件输出到本地
INSERT OVERWRITE LOCAL DIRECTORY '/home/bd/gogo/site_query_segment/site_wordList_sample' row format delimited fields terminated by '\t' select site,wordList from site_wordList_sample;
//下面用Word2Vec对site进行分类,首先site_word_count_2按照site进行聚合
set hive.map.aggr = false;
create table site_wordSet as select site,collect_set(word) wordSet from site_word_count_2 group by site;
//安装wordSet的大小降序排列
create table site_size_wordSet as select site,size(wordSet) size,wordSet from site_wordSet order by size desc;
